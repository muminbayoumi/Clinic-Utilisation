---
title: "General and Colorectal Clinics Utilisation Report"
author: "M.Mohamed;M.Ali;M.Rao"
output:
  word_document:
    toc: yes
  pdf_document:
    extra_dependencies: ["flafter"]
    keep_tex: yes
    md_extensions: +bracketed_spans
    pandoc_args: --lua-filter=color-text.lua
    toc: yes
  html_notebook:
    code_folding: hide
    md_extensions: +bracketed_spans
    pandoc_args: --lua-filter=color-text.lua
    toc: yes
  html_document:
    df_print: paged
    toc: yes
fig_caption: yes
tables: yes
editor_options:
  chunk_output_type: console
header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
- \usepackage{flafter}
---
```{r load-packages,include=FALSE,warning=F}
library(tidyverse)
library(ggnewscale)
library(magrittr)
library(here)
library(readxl)
library(RColorBrewer)
library(lubridate)
library(forcats)
library(gridExtra)
library(ggpubr)
library(extrafont)

loadfonts()
setwd(here::here())
source(file="OLD.R")
```

## A comparison across clinics and between pilgrim and peripheral sites
***
The aim of this project is to audit our use of general surgery and colorectal surgery clinics. We acquired our clinic attendance data from hospital information services. We further analysed this data to assess our utilization and DNAs. These are the clinic codes use for the purpose of this analysis **`r unique(CU$Session.Clinic.Code)`**

***
```{cat, include=F,engine.opts = list(file = "color-text.lua")}
Span = function(span)
  color = span.attributes['color']
-- if no color attribute, return unchange
if color == nil then return span end

-- tranform to <span style="color: red;"></span>
  if FORMAT:match 'html' then
-- remove color attributes
span.attributes['color'] = nil
-- use style attribute instead
span.attributes['style'] = 'color: ' .. color .. ';'
-- return full span element
return span
elseif FORMAT:match 'latex' then
-- remove color attributes
span.attributes['color'] = nil
-- encapsulate in latex code
table.insert(
  span.content, 1,
  pandoc.RawInline('latex', '\\textcolor{'..color..'}{')
)
table.insert(
  span.content,
  pandoc.RawInline('latex', '}')
)
-- returns only span content
return span.content
else
  -- for other format return unchanged
return span
end
end
```
```{r include=F}
knitr::opts_chunk$set(echo=F, error=F, fig.align='center', fig.height=3, fig.width=4, message=FALSE, warning=FALSE, dev='png', dpi=400,out.extra = '',fig.pos = '')
```
\newpage
## 1.The Data
With a preliminary view we can see that our [Pilgrim Median Booking Rate]{color="blue"}:`r round(median(CU$BR[CU$PvP=='Pilgrim']),3)*100`% is marginally higher than our [Peripheral Median Booking Rate]{color="red"}:`r round(median(CU$BR[CU$PvP=='Peripheral']),3)*100`%.  Difference in median was found to be statistically significant at p-value of *`r round(wilcox.test(CU$BR~CU$PvP)$p.value,3)`*(Graph 1.1A). Similarly our [Pilgrim Median Utilizaton Rate]{color="blue"}:`r round(median(CU$True.U[CU$PvP=='Pilgrim']),3)*100`% is marginally higher than our [Peripheral Median Utilization Rate]{color="red"}:`r round(median(CU$True.U[CU$PvP=='Peripheral']),3)*100`%.  Difference in median was found to be statistically significant at p-value of *`r round(wilcox.test(CU$True.U~CU$PvP)$p.value,3)`*(Graph 1.1B)  

### Graph 1.1
```{r warning=FALSE,echo=F,message=FALSE,error=F,fig.width=6,fig.height=3}
p1 <- CU %>% ggplot(aes(BR,fill=PvP))+geom_density(alpha=0.5)+
  geom_vline(xintercept =median(CU$BR[CU$PvP=='Pilgrim']),color='cyan')+
  geom_vline(xintercept =median(CU$BR[CU$PvP=='Peripheral']),color='red' )+
  labs(title='Density Plot Demonstrating Booking Rate \nacross sites',
       x='Booking Rate',
       y=" ",
       fill='Peripheral Vs Pilgrim')+
  theme(title = element_text(face='bold'),plot.title=element_text(size=8))

p2 <- CU %>% ggplot(aes(True.U,fill=PvP))+geom_density(alpha=0.7)+
  geom_vline(xintercept =median(CU$True.U[CU$PvP=='Pilgrim']),color='cyan')+
  geom_vline(xintercept =median(CU$True.U[CU$PvP=='Peripheral']),color='red' )+
  labs(x='Utilization',
       title='Density Plot Demonstrating Utilization \nacross sites',
       y="",
       fill='Peripheral Vs Pilgrim') + 
  theme(title = element_text(face='bold'),plot.title=element_text(size=8))
ggarrange(p1,p2,labels=c('A','B'),common.legend = TRUE, legend = "bottom")

```


```{r echo=F, paged.print=FALSE,fig.pos='H'}

t1<- CU %>% filter(OneVsTwo=="One Man") %>%  group_by(M,OneVsTwo,PvP) %>% summarise(count=n()) %>% arrange(M,PvP,OneVsTwo) %>% mutate(Site=PvP) %>% select(-PvP)

t2<- CU %>% filter(OneVsTwo=="Two Man") %>%  group_by(M,OneVsTwo,PvP) %>% summarise(count=n()) %>% arrange(M,PvP,OneVsTwo) %>% mutate(Site=PvP)%>% select(-PvP)
knitr::kable(list(t1,t2),format = "latex",booktabs=T,caption = "Total Number of One and Two Man Clinics for Pilgrim and Peripheral Sites") 
```
### Graph-1.2 Histogram demonstrating the distribution of Clinic Utilizatation Rates
```{r warning=FALSE,echo=F,message=FALSE,error=F,fig.width=6}
p3 <-  CU %>% ggplot(aes(True.U))+
  geom_histogram(fill='Maroon',color="White",
                 aes(y=(..count..)/sum(..count..)),
                 bins=4)+
  scale_y_continuous(labels=scales::percent) +facet_wrap(~PvP)
p3 + 
  labs( x="Utilization Rate",
        y="Proportion of Clinics",
        subtitle="# of Clinics 196 over the period between Aug 2019 and Jan 2020" )+
  scale_fill_viridis_d(option = "cividis",begin = 0.1,end = 0.9)

```  


## 2.Further Breakdown
The following graphs demonstrate per clinic data. [**Black Shapes**]{color='black'} demonstrate booking rate while [**Red Shapes**]{color='red'} demonstrate utilization rates. These are monthly rates ie the actual figure is an average of clinics used per month. **Booking rate** is $$\frac{initial\ booked slots}{total\ available\ slots}$$ while [**Utilization Rate**]{color='red'} is  $$\frac{attended \ clinic\  slots}{booked\ slots}$$

### Graph-2.1 Booking and Utilization rate per month for One Man clinics
```{r echo=F, error=F, fig.align='center', fig.height=7, fig.width=9, message=FALSE, warning=FALSE, dev='png', dpi=400}


PCD1 <- CU %>%
  filter(OneVsTwo=="One Man") %>% 
  group_by(Session.Clinic.Code,M,OneVsTwo)%>%
  summarise(MedianBooking=median(Utilisation),MedianUtilization=median(True.U),MedianTS=median(CU$Total.Slots[CU$OneVsTwo=="One Man"]),count=n()) 

PCD1.1 <- CU %>%
  filter(OneVsTwo == "One Man") %>%
  group_by(Session.Clinic.Code) %>%
  summarise(MedianBooking = median(Utilisation),
            MedianUtilization = median(True.U) , 
            MedianTS = median(CU$Total.Slots[CU$OneVsTwo == "One Man"]), 
            count = n())


plotPCD <- PCD1 %>% filter(Session.Clinic.Code!="SD-MMCSD") %>%
  ggplot(aes(x=Session.Clinic.Code,shape = M))+
  geom_point(
    stat = "identity",
    position=position_jitter(h=0.01,w=.22,seed = 2),
    aes(y=MedianBooking,
        size=3),show.legend = F)+ 
  new_scale_colour()+
  geom_point(aes(y=MedianUtilization,
                 x=as.numeric(as_factor(Session.Clinic.Code))+0.2),
             position=position_jitter(h=0.01,w=.22,seed = 2),
             color='Maroon',size=3.5,)+
  scale_y_continuous(limits=c(0.5,1.05),labels=scales::percent) +
  geom_hline(yintercept =9/11,alpha=.8,color='red')+
  new_scale_colour() +
  geom_point(data = PCD1.1, aes(y = MedianUtilization, x = as.numeric(as_factor(Session.Clinic.Code))), shape = 5, color = "navy", alpha = 0.7, size = 8) +
  geom_rect(aes(ymin=-Inf ,ymax=Inf,
                xmin=as.numeric(as_factor(Session.Clinic.Code))-0.5,
                xmax=as.numeric(as_factor(Session.Clinic.Code))+0.5
  ),
  alpha=0,fill="white",color="grey",linetype=4)


plotPCD +
  labs(x="Clinic",y="Utilization",
       subtitle = paste0("Black shows Booking Rates while red shows end Utilization Rates, \nRed line is ~ 80% Utilisation \nTotal Number of Clinics: ",table(CU$OneVsTwo)[1], "  between Aug '19 - Jan '20","\n Blue diamonds show median utilization "),
       shape="Month",
       size=NULL
  )+
  theme(axis.text.x = element_text(angle = 70,
                                   vjust = 0.5,
                                   face = 'bold'),
        title =element_text(face = "bold"),
        plot.subtitle = element_text(face = "italic"),
        axis.ticks.x = element_line(size = unit(2,'mm'),lineend = 'round',colour = 'grey30'),
        ) + theme(legend.text = element_text(size = 11), 
    legend.title = element_text(size = 11))
```

### Graph-2.2 Booking and Utilization Rates per month for Two Man clinics
```{r echo=F, error=F, fig.align='center', fig.height=7, fig.width=9, message=FALSE, warning=FALSE, dev='png', dpi=400}
PCD2 <- CU %>%
  filter(OneVsTwo == "Two Man") %>%
  group_by(Session.Clinic.Code, M, OneVsTwo) %>%
  summarise(MedianBooking = median(Utilisation), 
            MedianUtilization = median(True.U),
            MedianTS = median(CU$Total.Slots[CU$OneVsTwo == "Two Man"]), 
            count = n())
PCD2.1 <- CU %>%
  filter(OneVsTwo == "Two Man") %>%
  group_by(Session.Clinic.Code) %>%
  summarise(MedianBooking = median(Utilisation),
            MedianUtilization = median(True.U) , 
            MedianTS = median(CU$Total.Slots[CU$OneVsTwo == "Two Man"]), 
            count = n())

plotPCD2 <- PCD2 %>%
  filter(Session.Clinic.Code != "SD-MMCSD") %>%
  ggplot() +

  geom_point(stat = "identity", position = position_jitter(h = .01, w = .22, seed = 2), aes(y = MedianBooking, x = Session.Clinic.Code, shape = M), size = 3.5) +
  new_scale_colour() +
  geom_point(aes(
    y = MedianUtilization,
    x = as.numeric(as_factor(Session.Clinic.Code)) + 0.3,
    shape = M
  ),
  position = position_jitter(h = 0.01, w = .22, seed = 2), color = "Maroon", size = 3.5
  ) +
  scale_y_continuous(limits = c(0.495, 1.05), labels = scales::percent) +
  new_scale_colour() +
  geom_point(data = PCD2.1, aes(y = MedianUtilization, x = as.numeric(as_factor(Session.Clinic.Code))), shape = 5, color = "navy", alpha = 0.7, size = 8) +
  geom_hline(yintercept = 17 / 20, alpha = .8, color = "red")+
  geom_rect(aes(ymin=-Inf ,ymax=Inf,
                xmin=as.numeric(as_factor(Session.Clinic.Code))-0.5,
                xmax=as.numeric(as_factor(Session.Clinic.Code))+0.5
  ),
  alpha=0,fill="white",color="grey",linetype=4)

plotPCD2 + labs(
  x = "Clinic",
  y = "Utilization",
  subtitle = paste0("Black shows Booking Rates while red shows end Utilization Rates, \nRed line is ~ 80% Utilisation \nTotal Number of Clinics: ", table(CU$OneVsTwo)[2], "  between Aug '19 - Jan '20","\n Blue diamonds show median utilization "), shape = "Month"
) +
  theme(
    title = element_text(face = "bold"),
    plot.subtitle = element_text(face = "italic"),
    axis.text.x = element_text(
      angle = 70,
      vjust = 0.5,
      face = "bold"
    ),
    axis.ticks.x = element_line(size = unit(2, "mm"), lineend = "round", colour = "grey30")
  )
```

### Graph-2.3 Utilization and Booking Rate per month across Peripheral vs Pilgrim clinics
```{r warning=FALSE,echo=F,message=FALSE,error=F,dev='png',fig.height=4, fig.width=6,dpi=400,fig.align='center'}
PHD <- CU %>% group_by(PvP,M) %>% summarise(MedianBooking=median(Utilisation),MedianUtil=median(True.U))

PHD %>% ggplot(aes(x=M,shape=PvP))+ geom_point(aes(y=MedianBooking),color='black',size=4) + new_scale_color()+  geom_point(aes(y=MedianUtil),color='Maroon',size=4,position = position_nudge(x=0.4)) +
  geom_hline(yintercept = 0.8,color="Red")+
  scale_y_continuous(limits=c(0.6,1),labels=scales::percent)+
  labs(subtitle = paste0("Period Between Aug 19 and Jan 20 is shown","\nNo. Peripheral Clinics: ",table(CU$PvP)[1]," | ","No. Pilgrim Clinics:",table(CU$PvP)[2]),shape="Site",x="Month",y="Rate")+theme(title = element_text(face="bold"),plot.subtitle = element_text(face="italic"))

```

### Graph-2.4 Utilization and Booking Rate per month across Peripheral vs Pilgrim clinics
```{r warning=FALSE,echo=F,message=FALSE,error=F,fig.height=4, fig.width=6,dev='png',dpi=400,fig.align='center'}
PSD <- CU %>% group_by(Clinic.Hospital,M) %>% summarise(MedianBooking=median(Utilisation),MedianUtil=median(True.U))

PSD %>% ggplot(aes(x=M,shape=Clinic.Hospital))+ geom_point(aes(y=MedianBooking),color='black',size=4) + new_scale_color()+  geom_jitter(aes(y=MedianUtil),color='Maroon',size=4,position = position_nudge(x=0.4)) +
  geom_hline(yintercept = 0.8,color="Red")+
  scale_y_continuous(limits=c(0.6,1),labels=scales::percent)+
  labs(subtitle = paste0("Period Between Aug 19 and Jan 20 is shown","\nNo. Johnson Hosp: ",table(CU$Clinic.Hospital)[1]," | ","No. Pilgrim Clinics:",table(CU$Clinic.Hospital)[2]," | ","Skegness and District:",table(CU$Clinic.Hospital)[3]),shape="Site",x="Month",y="Rate")+theme(title = element_text(face="bold"),plot.subtitle = element_text(face="italic"))
```

### Graph-2.5 Per Clinic DNA Rate
```{r}
DNAData2 <- CU %>% group_by(Session.Clinic.Code,OneVsTwo) %>% summarise(MedianD=median(DNARate,na.rm = T),count=n()) %>% filter(Session.Clinic.Code!="SD-MMCSD")

  PLotDNA2 <- DNAData2 %>% ggplot(aes(y=MedianD,x=Session.Clinic.Code,col=Session.Clinic.Code))+
    geom_point(size=3.5,shape=20)+
    scale_y_continuous(labels= scales::percent)+ 
    facet_wrap(~OneVsTwo,nrow = 2)+
    theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank())
PLotDNA2 +
  labs(x= "Clinic Code",
       y="Mean DNA Rate",
       col="Clinic Code")
```

***

## 3.Results & Discussion

[Graph-2.1](#graph2.1) and [Graph-2.2](#graph2.2) show a clear underbooking with even clearer non-attendance.
[Graph-2.4](#graph2.4) & [Graph-2.3](#graph2.3) demonstrates again underutilized peripheral clinics clinics(p-value:`r round(wilcox.test(CU$True.U~CU$PvP)$p.value,3)`) despite having similar Booking Rates. This appears to be more during certain month. Again however due the small sample sizes it is not possible to perform adequate statistical analysis. 

Initially it seems that the differences although statistically significant were small. However when consulting the last 4 charts it seems evident that a notable number of our clinics were underbooked at 80% booking rate(which translates to 2 clinic slots for 1-man-clinics and about 3 clinic slots for 2-man-clinics). Although those numbers warrant attention their statistical significance is not easily demonstrated due to the small sample sizes(As shown on [Table 1.1](#table_1.1)).  If we were to assume their significance  the next question we need to answer is *why?*.

### 3.1 Current Process and suggested alternative

  On further discussion with staff responsible for clinic booking we now  think most deficits in booking rates is due to patient calling in 1 or 2 days before and cancelling. A patient would be considered as DNA only if he/she was still recorded to come in on the day of the clinic but didn't. 

  Currently patient get booked on to clinics by a primary booking team at pilgrim hospital who allocate clinic slots. Staff in peripheral clinics are not able to book patients on short notice as they wouldnt be aware about cancellations.
  
  If we can create joint list of overbooked patients who can be contacted on a short notice and redirect cancellations to be made at center where clinic is to be run this could potentially alleviate the the issue with underbooking clinics. 
This will only be possible if we have staff covering those sites on the dates patients would call.



  We suggest one possible option is to over book clinics with 1 -2 patients from the  next similar clinic and advising them that this is only a potential booking and that they will have a garaunteed booking ontop of that. That they should be ready to be called in 1-2 day's notice. 


This should bring up the booking rate as well as show us a complete true utilizaition rate to work on next audit cycle. the aim will be to create a tool whereby this utilization rate is automatically calculated and used to reasses on  a monthly basis. 
  

***  
  

## 4.Recommendations  

We suggest  the following recommendations:

* Create waiting list with prebooking patients on multiple clinics 
* Allocate Clinic Space by proximity  
* Monthly Review of Booking Rate  
* Improve Communication Between Staff accross sites  
* Disseminate This Report and following monthly Booking Rates to all concerned Staff  
* **Using Telephone Clinics to replace peripheral clinics / supplement available clinics**
* **Using Telephone appointments for patient who cancel within 1-2 days**

The last two recommendations are one of the few ideas that have worked so far in this covid era and there might be a utility for them in current climate and further down the line as well. 

  


